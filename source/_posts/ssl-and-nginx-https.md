---
title: SSL介绍及Nginx Https配置
date: 2018-07-08 19:18:34
tags:
- SSL
- Nginx
- HTTPS
categories:
- Web
- Web Server
- Security
thumbnail: /images/nginx.png
barnar:
---

现在大多数站点都使用了https协议，iOS应用也强制使用https连，https也是应用数据安全的需要。本文主要记录自己对SSL的了解，以及Nginx 中配置https的方法。
<!--more -->

## SSL介绍
SSL(Secure Sockets Layer 安全套接层),及其继任者传输层安全（Transport Layer Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层对网络连接进行加密。

SSL协议位于TCP/IP协议与各种应用层协议之间，为数据通讯提供安全支持。SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。

### SSL提供以下能力
- 认证用户和服务器，确保数据发送到正确的客户机和服务器；
- 加密数据以防止数据中途被窃取；
- 维护数据的完整性，确保数据在传输过程中不被改变。

### SSL工作流程
1. 服务器认证阶段：1）客户端向服务器发送一个开始信息“Hello”以便开始一个新的会话连接；2）服务器根据客户的信息确定是否需要生成新的主密钥，如需要则服务器在响应客户的“Hello”信息时将包含生成主密钥所需的信息；3）客户根据收到的服务器响应信息，产生一个主密钥，并用服务器的公开密钥加密后传给服务器；4）服务器回复该主密钥，并返回给客户一个用主密钥认证的信息，以此让客户认证服务器。
2. 用户认证阶段：在此之前，服务器已经通过了客户认证，这一阶段主要完成对客户的认证。经认证的服务器发送一个提问给客户，客户则返回（数字）签名后的提问和其公开密钥，从而向服务器提供认证。

SSL提供的安全通道具有以下特性：
- 机密性：SSL协议使用密钥加密通信数据。
- 可靠性：服务器和客户都会被认证，客户的认证是可选的。
- 完整性：SSL协议会对传送的数据进行完整性检查。

从SSL 协议所提供的服务及其工作流程可以看出，SSL协议运行的基础是商家对消费者信息保密的承诺，这就有利于商家而不利于消费者。在电子商务初级阶段，由于运作电子商务的企业大多是信誉较高的大公司，因此这问题还没有充分暴露出来。但随着电子商务的发展，各中小型公司也参与进来，这样在电子支付过程中的单一认证问题就越来越突出。虽然在SSL3.0中通过数字签名和数字证书可实现浏览器和Web服务器双方的身份验证，但是SSL协议仍存在一些问题，比如，只能提供交易中客户与服务器间的双方认证，在涉及多方的电子交易中，SSL协议并不能协调各方间的安全传输和信任关系。在这种情况下，Visa和 MasterCard两大信用卡公组织制定了SET协议，为网上信用卡支付提供了全球性的标准。

### SSL体系结构
SSL的体系结构中包含两个协议子层，其中底层是SSL记录协议层（SSL Record Protocol Layer）；高层是SSL握手协议层（SSL HandShake Protocol Layer）。

SSL记录协议层的作用是为高层协议提供基本的安全服务。SSL纪录协议针对HTTP协议进行了特别的设计，使得超文本的传输协议HTTP能够在SSL运行。纪录封装各种高层协议，具体实施压缩解压缩、加密解密、计算和校验MAC等与安全有关的操作。
SSL握手协议层包括SSL握手协议（SSL HandShake Protocol）、SSL密码参数修改协议（SSL Change Cipher Spec Protocol）、应用数据协议（Application Data Protocol）和SSL告警协议（SSL Alert Protocol）。握手层的这些协议用于SSL管理信息的交换，允许应用协议传送数据之间相互验证，协商加密算法和生成密钥等。SSL握手协议的作用是协调客户和服务器的状态，使双方能够达到状态的同步。

### SSL记录协议

SSL记录协议（Record Protocol）为SSL连提供两种服务。
- 保密性：利用握手协议所定义的共享密钥对SSL净荷（Payload）加密。
- 完整性：利用握手协议所定义的共享的MAC密钥来生成报文的鉴别码（MAC）。
SSL的工作过程如下。
#### 发送方的工作过程为：
1. 从上层接受要发送的数据（包括各种消息和数据）；
2. 对信息进行分段，分成若干纪录；
3. 使用指定的压缩算法进行数据压缩（可选）；
4. 使用指定的MAC算法生成MAC；
5. 使用指定的加密算法进行数据加密；
6. 添加SSL记录协议的头，发送数据。
#### 接收方的工作过程为：
1. 接收数据，从SSL记录协议的头中获取相关信息；
2. 使用指定的解密算法解密数据；
3. 使用指定的MAC算法校验MAC；
4. 使用压缩算法对数据解压缩（在需要进行）；
5. 将记录进行数据重组；
6. 将数据发送给高层。
SSL记录协议处理的最后一个步骤是附加一个SSL记录协议的头，以便构成一个SSL记录。SSL记录协议头中包含了SSL记录协议的若干控制信息。

### SSL的会话状态
会话（Session）和连接（Connection）是SSL中两个重要的概念，在规范中定义如下。
（1）SSL连接：用于提供某种类型的服务数据的传输，是一种点对点的关系。一般来说，连接的维持时间比较短暂，并且每个连接一定与某一个会话相关联。
（2）SSL会话：是指客户和服务器之间的一个关联关系。会话通过握手协议来创建。它定义了一组安全参数。
一次会话过程通常会发起多个SSL连接来完成任务，例如一次网站的访问可能需要多个HTTP/SSL/TCP连接来下载其中的多个页面，这些连接共享会话定义的安全参数。这种共享方式可以避免为每个SSL连接单独进行安全参数的协商，而只需在会话建立时进行一次协商，提高了效率。
每一个会话（或连接）都存在一组与之相对应的状态，会话（或连接）的状态表现为一组与其相关的参数集合，最主要的内容是与会话（或连接）相关的安全参数的集合，用会话（或连接）中的加密解密、认证等安全功能的实现。在SSL通信过程中，通信算法的状态通过SSL握手协议实现同步。
根据SSL协议的约定，会话状态由以下参数来定义：
（1）会话标识符：是由服务器选择的任意字节序列，用于标识活动的会话或可恢复的会话状态。
（2）对方的证书：会话对方的X.509v3证书。该参数可为空。
（3）压缩算法：在加密之前用来压缩数据的算法。
（4）加密规约（Cipher Spec）：用于说明对大块数据进行加密采用的算法，以及计算MAC所采用的散列算法。
（5）主密值：一个48字节长的秘密值，由客户和服务器共享。
（6）可重新开始的标识：用于指示会话是否可以用于初始化新的连接。
连接状态由以下参数来定义：
（1）服务器和客户器的随机数：是服务器和客户为每个连接选择的用于标识连接的字节序列。
（2）服务器写MAC密值：服务器发送数据时，生成MAC使用的密钥，长度为128 bit。
（3）客户写MAC密值，服务器发送数据时，用于数据加密的密钥，长度为128 bit 。
（4）客户写密钥：客户发送数据时，用于数据加密的密钥，长度为128 bit。
（5）初始化向量：当使用CBC模式的分组密文算法是=时，需要为每个密钥维护初始化向量。
（6）序列号：通信的每一端都为每个连接中的发送和接收报文维持着一个序列号。

## HTTPS介绍

HTTPS（Hypertext Transfer Protocol Secure）安全超文本传输协议
它是由Netscape开发并内置于其浏览器中，用于对数据进行压缩和解压操作，并返回网络上传送回的结果。HTTPS实际上应用了Netscape的安全套接字层（SSL）作为HTTP应用层的子层。（HTTPS使用端口443，而不是象HTTP那样使用端口80来和TCP/IP进行通信。）SSL使用40 位关键字作为RC4流加密算法，这对于商业信息的加密是合适的。HTTPS和SSL支持使用X.509数字认证，如果需要的话用户可以确认发送者是谁。
https是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，https的安全基础是SSL，因此加密的详细内容请看SSL。
它是一个URI scheme(抽象标识符体系)，句法类同http:体系。用于安全的HTTP数据传输。https:URL表明它使用了HTTP，但HTTPS存在不同于HTTP的默认端口及一个加密/身份验证层（在HTTP与TCP之间）。这个系统的最初研发由网景公司进行，提供了身份验证与加密通讯方法，它被广泛用于万维网上安全敏感的通讯，例如交易支付方面。
限制
它的安全保护依赖浏览器的正确实现以及服务器软件、实际加密算法的支持.
一种常见的误解是“银行用户在线使用https:就能充分彻底保障他们的银行卡号不被偷窃。”实际上，与服务器的加密连接中能保护银行卡号的部分，只有用户到服务器之间的连接及服务器自身。并不能绝对确保服务器自己是安全的，这点甚至已被攻击者利用，常见例子是模仿银行域名的钓鱼攻击。少数罕见攻击在网站传输客户数据时发生，攻击者尝试窃听数据于传输中。
商业网站被人们期望迅速尽早引入新的特殊处理程序到金融网关，仅保留传输码(transaction number)。不过他们常常存储银行卡号在同一个数据库里。那些数据库和服务器少数情况有可能被未授权用户攻击和损害。

## SSL证书

### 自制证书
### 第三方机构签发证书

## Nginx中配置
